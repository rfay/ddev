# In order to use Traefik Middleware plugins that are defined globally in ~/.ddev/traefik/static_config.middleware_plugins.yaml you must insert here the dynamic YAML config provided by the plugin page->Install Plugin at https://plugins.traefik.io/plugins
# You can remove or change the examples here. But it is crucial to follow their format
# In particular, within the middlewareAssignments section, you must add the plugin name to the routers that you want to use it in. Make sure to include the {{ .App.Name }}- portion as that will target the current project's routers
# Likewise, you must prepend {{ .App.Name }}- to the plugin name within the middlewareDefinitions: section. These will be added in their entirety to the http.middlewares node in the /.ddev/traefik/config/<project>.yaml file that is dynamically re-generated at `ddev start`
# You can try just running the examples as-is and inspect the <project>.yaml file that is generated to see what the final outcome should look like
# Finally, you can debug it by going to http://localhost:10999/dashboard/ and seeing if there were any errors for Routers or Middleware. You can click on any that are red to see the error message.

{{ $webEnv := .App.WebEnvironment }}
middlewareAssignments:
  {{ .App.Name }}-web-80-http:
      - {{ .App.Name }}-redirectHttps
      - {{ .App.Name }}-my-fail2ban
  {{ .App.Name }}-web-80-https:
      - {{ .App.Name }}-my-fail2ban

middlewareDefinitions:
  {{ .App.Name }}-redirectHttps:
    redirectScheme:
      scheme: https
      permanent: true
  my-fail2ban:
    plugin:
      fail2ban:
        allowlist:
          ip: ::1,127.0.0.1
        denylist:
          ip: 192.168.0.0/24
        rules:
          bantime: 3h
          enabled: "true"
          findtime: 10m
          maxretry: "4"
          statuscode: 400,401,403-499
